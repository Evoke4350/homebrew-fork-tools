# fork-tools GitHub Actions CI

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Linting job
  lint:
    name: Lint with ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Lint all shell scripts
        run: |
          find . -name '*.sh' \
            -not -path './.git/*' \
            -not -path './tests/*' \
            -not -path './_site/*' \
            -exec shellcheck -x {} +

  # Syntax check job
  syntax:
    name: Syntax Check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Check bash syntax
        run: |
          for script in *.sh; do
            echo "Checking: $script"
            bash -n "$script" || exit 1
          done

  # Test job
  test:
    name: Tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        bats-version: [v1.11.0]
    steps:
      - uses: actions/checkout@v4

      - name: Install BATS
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            git clone https://github.com/bats-core/bats-core.git
            sudo bats-core/install.sh /usr/local
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install bats
          fi

      - name: Run tests
        run: |
          bats -r --print-output-on-failure tests/

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: |
            tests/tmp/
            **/TEST-*.xml
          if-no-files-found: ignore

  # Docker test job
  docker:
    name: Docker Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build test image
        run: docker build -t fork-tools-test -f Dockerfile.test .

      - name: Run tests in Docker
        run: docker run --rm fork-tools-test


  # Integration test job (macOS only - ubuntu covered by BATS tests)
  integration:
    name: Integration Tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install test dependencies
        run: |
          brew install bats git

      - name: Configure git for tests
        run: |
          git config --global user.email "ci@test.com"
          git config --global user.name "CI Test"
          git config --global init.defaultBranch main
          git config --global --add safe.directory '*'

      - name: Run integration tests
        run: |
          bash tests/test-integration.sh

      - name: Test fork-report command
        run: |
          GITHUB_USERNAMES=testuser ./fork-report.sh --version
          GITHUB_USERNAMES=testuser ./fork-report.sh --help

  # Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run security scan
        run: |
          # Check for secrets
          git log --all --full-history --source -- "*sh" | \
            grep -i "password\|secret\|token\|api_key\|private_key" || true

          # Check for eval/eval-like patterns
          grep -rn "eval\|exec.*\$$" *.sh || true

  # Build status check
  status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [lint, syntax, test, docker, integration]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.syntax.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.docker.result }}" != "success" ]] || \
             [[ "${{ needs.integration.result }}" != "success" ]]; then
            echo "❌ One or more jobs failed"
            exit 1
          fi
          echo "✅ All jobs passed successfully"
